---
- name: Install cert-manager on K3s cluster
  hosts: main_server
  become: yes

  vars:
    cert_manager_version: v1.16.2
    letsencrypt_email: pepe.marquezromero@protonmail.com

  tasks:
    - name: Install cert-manager CRDs and resources
      shell: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.yaml
      args:
        executable: /bin/bash
      register: cert_manager_install

    - name: Wait for cert-manager pods to be ready
      shell: |
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n cert-manager --timeout=300s
      args:
        executable: /bin/bash
      retries: 3
      delay: 10
      register: cert_manager_ready
      until: cert_manager_ready.rc == 0

    - name: Create Let's Encrypt staging ClusterIssuer
      shell: |
        kubectl apply -f - <<EOF
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-staging
        spec:
          acme:
            server: https://acme-staging-v02.api.letsencrypt.org/directory
            email: {{ letsencrypt_email }}
            privateKeySecretRef:
              name: letsencrypt-staging
            solvers:
            - http01:
                ingress:
                  class: traefik
        EOF
      args:
        executable: /bin/bash

    - name: Create Let's Encrypt production ClusterIssuer
      shell: |
        kubectl apply -f - <<EOF
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-prod
        spec:
          acme:
            server: https://acme-v02.api.letsencrypt.org/directory
            email: {{ letsencrypt_email }}
            privateKeySecretRef:
              name: letsencrypt-prod
            solvers:
            - http01:
                ingress:
                  class: traefik
        EOF
      args:
        executable: /bin/bash

    - name: Check cert-manager pods status
      command: kubectl get pods -n cert-manager
      register: cert_manager_pods
      changed_when: false

    - name: Display cert-manager pods status
      debug:
        msg: "{{ cert_manager_pods.stdout_lines }}"

    - name: Check ClusterIssuers
      command: kubectl get clusterissuers
      register: cluster_issuers
      changed_when: false

    - name: Display ClusterIssuers
      debug:
        msg: "{{ cluster_issuers.stdout_lines }}"

    - name: Display success message
      debug:
        msg:
          - "cert-manager installation complete!"
          - "ClusterIssuers created:"
          - "  - letsencrypt-staging (for testing)"
          - "  - letsencrypt-prod (for production)"
          - "Update your ingress annotations with:"
          - "  cert-manager.io/cluster-issuer: letsencrypt-prod"
